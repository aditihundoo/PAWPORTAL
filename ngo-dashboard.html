<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGO Dashboard - PawPortal</title>
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #f97316;
            --accent-color: #ef4444;
            --light-bg: #f9f9ff;
            --dark-text: #1e293b;
            --light-text: #ffffff;
            --gradient-primary: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            --gradient-secondary: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
            --gradient-accent: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            --section-bg: rgba(255, 255, 255, 0.98);
            --card-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --hover-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --border-radius: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body {
            background-color: var(--light-bg);
            color: var(--dark-text);
            font-family: 'Poppins', 'Arial', sans-serif;
            margin: 0;
            min-height: 100vh;
        }
        .portal-header {
            background: var(--gradient-primary);
            color: var(--light-text);
            padding: 2.5rem 0 1.5rem 0;
            text-align: center;
            box-shadow: var(--card-shadow);
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
        }
        .portal-header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
        }
        .portal-header p {
            color: #e0e7ff;
            font-size: 1.15rem;
        }
        .portal-nav {
            background: var(--gradient-secondary);
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 1.2rem 0;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.08);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        .portal-nav a {
            color: var(--light-text);
            text-decoration: none;
            font-weight: 600;
            padding: 0.7rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            transition: var(--transition);
            position: relative;
        }
        .portal-nav a:hover, .portal-nav a.active {
            background: var(--gradient-primary);
            color: #fff;
            box-shadow: var(--card-shadow);
        }
        .portal-main {
            max-width: 1000px;
            margin: 3rem auto;
            background: var(--section-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 3rem 2.5rem;
            text-align: center;
        }
        .portal-main h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-size: 2rem;
        }
        .portal-main p {
            font-size: 1.15rem;
            color: #475569;
            margin-bottom: 2rem;
        }
        .portal-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            justify-content: center;
        }
        .portal-action {
            background: var(--gradient-primary);
            color: var(--light-text);
            border-radius: var(--border-radius);
            padding: 2.2rem 2.8rem;
            min-width: 220px;
            box-shadow: var(--card-shadow);
            font-size: 1.15rem;
            font-weight: 600;
            text-decoration: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
        }
        .portal-action:hover {
            transform: translateY(-8px) scale(1.04);
            box-shadow: var(--hover-shadow);
            background: var(--gradient-secondary);
            color: #fff;
        }
        .portal-section {
            margin-top: 2rem;
        }
        form {
            background: #f8fafc;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(44,62,80,0.08);
            margin: 0 auto;
        }
        input, textarea, select, button {
            font-family: inherit;
        }
        input[type="text"], input[type="number"], input[type="email"], input[type="tel"], textarea {
            width: 100%;
            padding: 0.9rem;
            border-radius: 12px;
            border: 1.5px solid #e2e8f0;
            font-size: 1rem;
            margin-bottom: 1.2rem;
            transition: var(--transition);
            background: #fff;
        }
        input:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.08);
            outline: none;
        }
        button[type="submit"], button, .portal-action {
            cursor: pointer;
            background: var(--gradient-primary);
            color: #fff;
            border: none;
            border-radius: 50px;
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
        }
        button[type="submit"]:hover, button:hover {
            background: var(--gradient-secondary);
            color: #fff;
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            background: #fff;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }
        th, td {
            padding: 1rem;
            text-align: left;
        }
        th {
            background: var(--gradient-primary);
            color: #fff;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }
        tr:nth-child(even) {
            background: #f3f4f6;
        }
        tr:hover {
            background: #ede9fe;
        }
        img {
            border-radius: 12px;
        }
        .success-message {
            color: #10b981;
            background: #e0f7ef;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1.2rem;
            font-weight: 600;
            display: inline-block;
        }
        @media (max-width: 900px) {
            .portal-main {
                padding: 2rem 0.5rem;
            }
            .portal-actions {
                flex-direction: column;
                gap: 1.2rem;
            }
        }
        @media (max-width: 600px) {
            .portal-header h1 {
                font-size: 1.5rem;
            }
            .portal-main h2 {
                font-size: 1.2rem;
            }
            .portal-action {
                padding: 1.2rem 1.5rem;
                font-size: 1rem;
            }
            th, td {
                padding: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="portal-header">
        <h1 id="ngoName">Welcome to NGO Dashboard</h1>
        <p>Manage your dogs, view adoption requests, and update your organization info here.</p>
    </div>
    <nav class="portal-nav">
        <a href="#" class="active" data-section="dashboard">Dashboard</a>
        <a href="#" data-section="add-dog">Add Dog</a>
        <a href="#" data-section="manage-dogs">Manage Dogs</a>
        <a href="#" data-section="adoption-requests">Adoption Requests</a>
        <a href="#" id="logoutBtn">Logout</a>
    </nav>
    <main class="portal-main">
        <section id="dashboard-section" class="portal-section">
            <h2>NGO Dashboard</h2>
            <p>Use the options below to manage your organization's dogs and adoption process. More features coming soon!</p>
            <div class="portal-actions">
                <a href="#" class="portal-action" data-section="add-dog">Add a New Dog</a>
                <a href="#" class="portal-action" data-section="manage-dogs">View & Edit Dogs</a>
                <a href="#" class="portal-action" data-section="adoption-requests">View Adoption Requests</a>
                <a href="#" class="portal-action" data-section="update-info">Update Organization Info</a>
            </div>
        </section>
        <section id="add-dog-section" class="portal-section" style="display: none;">
            <h2>Add a New Dog</h2>
            <form id="dogForm">
                <input type="text" id="dogName" placeholder="Dog Name" required />
                <input type="text" id="breed" placeholder="Breed" required />
                <input type="number" id="age" placeholder="Age (in years)" min="0" step="0.1" required />
                <input type="number" id="weight" placeholder="Weight (in kg)" min="0" step="0.1" required />
                <textarea id="healthStatus" placeholder="Health Status (e.g., Vaccinated, Spayed/Neutered, Any medical conditions)" rows="3" required></textarea>
                <input type="file" id="imageInput" accept="image/*" required />
                <button type="submit">Upload Dog Info</button>
            </form>
        </section>
        <section id="manage-dogs-section" class="portal-section" style="display:none">
            <h2>Manage Dogs</h2>
            <div style="overflow-x:auto;">
                <table id="dogsTable" style="width:100%; border-collapse:collapse; margin-top:1.5rem;">
                    <thead>
                        <tr style="background:#f4f6f8;">
                            <th style="padding:0.7rem; border-bottom:1px solid #ddd;">Image</th>
                            <th style="padding:0.7rem; border-bottom:1px solid #ddd;">Name</th>
                            <th style="padding:0.7rem; border-bottom:1px solid #ddd;">Age</th>
                            <th style="padding:0.7rem; border-bottom:1px solid #ddd;">Breed</th>
                            <th style="padding:0.7rem; border-bottom:1px solid #ddd;">Health Description</th>
                            <th style="padding:0.7rem; border-bottom:1px solid #ddd;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dog rows will be inserted here by JS -->
                    </tbody>
                </table>
            </div>
        </section>
        <section id="adoption-requests-section" class="portal-section" style="display:none">
            <h2>Adoption Requests</h2>
            <div style="overflow-x:auto;">
                <table id="adoptionRequestsTable" style="width:100%; border-collapse:collapse; margin-top:1.5rem;">
                    <thead>
                        <tr style="background:#f4f6f8;">
                            <th style="padding:0.7rem; border-bottom:1px solid #ddd;">Requester Name</th>
                            <th style="padding:0.7rem; border-bottom:1px solid #ddd;">Dog Name</th>
                            <th style="padding:0.7rem; border-bottom:1px solid #ddd;">Contact</th>
                            <th style="padding:0.7rem; border-bottom:1px solid #ddd;">Status</th>
                            <th style="padding:0.7rem; border-bottom:1px solid #ddd;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Requests will be inserted here by JS -->
                    </tbody>
                </table>
            </div>
        </section>
        <section id="update-info-section" class="portal-section" style="display:none">
            <h2>Update Organization Info</h2>
            <form id="orgInfoForm" style="max-width: 500px; margin: 0 auto; background: #f8f9fa; padding: 2rem 2rem 1rem 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(44,62,80,0.08);">
                <div style="margin-bottom: 1.2rem;">
                    <label for="orgName" style="display:block; font-weight:600; margin-bottom:0.4rem;">Organization Name</label>
                    <input type="text" id="orgName" name="orgName" required style="width:100%; padding:0.6rem; border-radius:6px; border:1px solid #ccc;">
                </div>
                <div style="margin-bottom: 1.2rem;">
                    <label for="orgEmail" style="display:block; font-weight:600; margin-bottom:0.4rem;">Email</label>
                    <input type="email" id="orgEmail" name="orgEmail" required style="width:100%; padding:0.6rem; border-radius:6px; border:1px solid #ccc;">
                </div>
                <div style="margin-bottom: 1.2rem;">
                    <label for="orgPhone" style="display:block; font-weight:600; margin-bottom:0.4rem;">Phone</label>
                    <input type="tel" id="orgPhone" name="orgPhone" required style="width:100%; padding:0.6rem; border-radius:6px; border:1px solid #ccc;">
                </div>
                <div style="margin-bottom: 1.2rem;">
                    <label for="orgAddress" style="display:block; font-weight:600; margin-bottom:0.4rem;">Address</label>
                    <input type="text" id="orgAddress" name="orgAddress" required style="width:100%; padding:0.6rem; border-radius:6px; border:1px solid #ccc;">
                </div>
                <div style="margin-bottom: 1.2rem;">
                    <label for="orgDescription" style="display:block; font-weight:600; margin-bottom:0.4rem;">Description</label>
                    <textarea id="orgDescription" name="orgDescription" rows="3" required style="width:100%; padding:0.6rem; border-radius:6px; border:1px solid #ccc;"></textarea>
                </div>
                <button type="submit" style="width:100%; padding:0.8rem; background: var(--primary-color); color:#fff; border:none; border-radius:6px; font-size:1.1rem; font-weight:600; cursor:pointer; transition:background 0.2s;">Save</button>
            </form>
            <div class="success-message" id="orgSuccessMessage" style="display:none; color:green; text-align:center; margin-top:1.2rem;">
                Organization info updated successfully!
            </div>
        </section>
    </main>

    <!-- Request Details Modal -->
    <div id="requestDetailsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); backdrop-filter:blur(8px); z-index:1000;">
        <div style="background:white; width:90%; max-width:600px; margin:5% auto; padding:2rem; border-radius:var(--border-radius); box-shadow:var(--hover-shadow); position:relative;">
            <h3 style="color:var(--primary-color); margin-bottom:1.5rem;">Request Details</h3>
            <button onclick="closeRequestDetailsModal()" style="position:absolute; top:1rem; right:1rem; background:#e0e7ff; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer; font-size:1.2rem;">&times;</button>
            <div style="margin-bottom:1rem;">
                <p><strong>Type:</strong> <span id="requestDetailType"></span></p>
                <p><strong>Dog:</strong> <span id="requestDetailDog"></span></p>
                <p><strong>Status:</strong> <span id="requestDetailStatus" style="padding: 0.3rem 0.6rem; border-radius: 4px; color: white;"></span></p>
                <p><strong>Date:</strong> <span id="requestDetailDate"></span></p>
            </div>
            <div id="requestSpecificDetails" style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid #eee;">
                <!-- Specific details (visitor/sender info, message) will be inserted here by JS -->
            </div>
        </div>
    </div>
    <!-- End Request Details Modal -->

    <!-- Firebase Core SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>

    <!-- Firebase Auth SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <!-- Firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA2zAdnwkms_F-lVWZnA9q-4t_f014CkZQ",
            authDomain: "paw-portal-f651d.firebaseapp.com",
            projectId: "paw-portal-f651d",
            storageBucket: "paw-portal-f651d.firebasestorage.app",
            messagingSenderId: "178766672520",
            appId: "1:178766672520:web:123d27c8e353477579a53d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Fetch and display NGO name on page load
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                db.collection('ngos').doc(user.uid).get().then((ngoDoc) => {
                    if (ngoDoc.exists) {
                        const ngoData = ngoDoc.data();
                        const orgName = ngoData.organizationName || ngoData.name; // Fallback for older data
                        if (orgName) {
                            document.getElementById('ngoName').textContent = `Welcome, ${orgName}`;
                        }
                    }
                }).catch(error => {
                    console.error('Error fetching NGO data:', error);
                });
            } else {
                // If no user is logged in, redirect to the login page
                window.location.href = "ngo-portal.html";
            }
        });

        // Navigation functionality
        document.querySelectorAll('.portal-nav a, .portal-action').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.target.dataset.section;
                if (section) {
                    document.querySelectorAll('.portal-section').forEach(s => s.style.display = 'none');
                    document.getElementById(`${section}-section`).style.display = 'block';
                    document.querySelectorAll('.portal-nav a').forEach(a => a.classList.remove('active'));
                    e.target.classList.add('active');
                }
            });
        });

        // Dog form submission
        document.getElementById("dogForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const dogName = document.getElementById("dogName").value;
            const breed = document.getElementById("breed").value;
            const age = parseFloat(document.getElementById("age").value);
            const weight = parseFloat(document.getElementById("weight").value);
            const healthStatus = document.getElementById("healthStatus").value;
            const file = document.getElementById("imageInput").files[0];

            if (!file) return alert("Please select an image");

            // Upload to Cloudinary
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", "pawportal");
            const cloudName = "daskt2byc";

            try {
                const uploadRes = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                    method: "POST",
                    body: formData
                });

                const uploadData = await uploadRes.json();
                const imageUrl = uploadData.secure_url;

                // Get current user
                const user = firebase.auth().currentUser;
                if (!user) {
                    alert("You must be logged in as an NGO to upload.");
                    window.location.href = "ngo-portal.html";
                    return;
                }

                // Store in Firestore
                await db.collection("dogs").add({
                    name: dogName,
                    breed: breed,
                    age: age,
                    weight: weight,
                    healthStatus: healthStatus,
                    imageUrl: imageUrl,
                    ngoId: user.uid,  // Link to logged-in NGO
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert("Dog info uploaded successfully!");
                document.getElementById("dogForm").reset();
            } catch (error) {
                console.error("Error uploading:", error);
                alert("Error uploading dog info. Please try again.");
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function(event) {
            event.preventDefault();
            if (confirm('Are you sure you want to logout?')) {
                firebase.auth().signOut().then(() => {
                    window.location.href = "ngo-portal.html";
                });
            }
        });

        // Load and display dogs
        async function loadDogs() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            try {
                const snapshot = await db.collection("dogs")
                    .where("ngoId", "==", user.uid)
                    .get();

                const tbody = document.querySelector('#dogsTable tbody');
                tbody.innerHTML = '';

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:1.5rem;">No dogs found.</td></tr>';
                    return;
                }

                snapshot.forEach(doc => {
                    const dog = doc.data();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="padding:0.7rem; text-align:center;">
                            <img src="${dog.imageUrl}" alt="${dog.name}" style="width:60px; height:60px; object-fit:cover; border-radius:8px;">
                        </td>
                        <td style="padding:0.7rem;">${dog.name}</td>
                        <td style="padding:0.7rem;">${dog.age}</td>
                        <td style="padding:0.7rem;">${dog.breed}</td>
                        <td style="padding:0.7rem;">${dog.healthStatus || ''}</td>
                        <td style="padding:0.7rem;">
                            <button onclick="editDog('${doc.id}')" style="margin-right:0.5rem; padding:0.4rem 0.8rem; border:none; background:#1976d2; color:#fff; border-radius:4px; cursor:pointer;">Edit</button>
                            <button onclick="deleteDog('${doc.id}')" style="padding:0.4rem 0.8rem; border:none; background:#e74c3c; color:#fff; border-radius:4px; cursor:pointer;">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error("Error loading dogs:", error);
                alert("Error loading dogs. Please try again.");
            }
        }

        // Load dogs when manage dogs section is shown
        document.querySelector('a[data-section="manage-dogs"]').addEventListener('click', loadDogs);
        document.querySelector('.portal-action[data-section="manage-dogs"]').addEventListener('click', loadDogs);

        // Delete dog function
        async function deleteDog(dogId) {
            if (confirm('Are you sure you want to delete this dog?')) {
                try {
                    await db.collection("dogs").doc(dogId).delete();
                    loadDogs(); // Reload the table
                } catch (error) {
                    console.error("Error deleting dog:", error);
                    alert("Error deleting dog. Please try again.");
                }
            }
        }

        // Edit dog function
        async function editDog(dogId) {
            try {
                const doc = await db.collection("dogs").doc(dogId).get();
                if (doc.exists) {
                    const dog = doc.data();
                    // Populate edit form and show modal
                    // Add your edit form implementation here
                }
            } catch (error) {
                console.error("Error loading dog details:", error);
                alert("Error loading dog details. Please try again.");
            }
        }

        // Render adoption requests table
        async function renderAdoptionRequestsTable() {
            const tbody = document.querySelector('#adoptionRequestsTable tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:1.5rem;">Loading requests...</td></tr>';

            try {
                // Get the current NGO's ID
                const user = firebase.auth().currentUser;
                if (!user) {
                    throw new Error('No user logged in');
                }

                // Fetch adoption requests for this NGO
                const requestsSnapshot = await db.collection('adoptionRequests')
                    .where('ngoId', '==', user.uid)
                    .orderBy('createdAt', 'desc')
                    .get();

                if (requestsSnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:1.5rem;">No adoption requests found.</td></tr>';
                    return;
                }

                tbody.innerHTML = ''; // Clear loading message
                requestsSnapshot.forEach(doc => {
                    const request = doc.data();
                    const isPending = request.status === 'Pending' || request.status === 'Unread';
                    const requesterName = request.type === 'visit' ? request.visitorName : request.senderName;
                    const contact = request.type === 'visit' ? 
                        `${request.visitorEmail}<br>${request.visitorPhone}` : 
                        `${request.senderEmail}`;
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="padding:0.7rem;">${requesterName}</td>
                        <td style="padding:0.7rem;">${request.dogName} (${request.dogBreed})</td>
                        <td style="padding:0.7rem;">${contact}</td>
                        <td style="padding:0.7rem;">
                            <span style="padding: 0.3rem 0.6rem; border-radius: 4px; background: ${getStatusColor(request.status)}; color: white;">
                                ${request.status}
                            </span>
                        </td>
                        <td style="padding:0.7rem;">
                            ${isPending ? `
                                <button onclick="updateRequestStatus('${doc.id}', 'Approved')" 
                                    style="margin-right:0.5rem; padding:0.4rem 0.8rem; border:none; background:#27ae60; color:#fff; border-radius:4px; cursor:pointer;">
                                    Approve
                                </button>
                                <button onclick="updateRequestStatus('${doc.id}', 'Rejected')" 
                                    style="padding:0.4rem 0.8rem; border:none; background:#e74c3c; color:#fff; border-radius:4px; cursor:pointer;">
                                    Reject
                                </button>
                            ` : ''}
                            <button onclick="viewRequestDetails('${doc.id}')" 
                                style="margin-left:0.5rem; padding:0.4rem 0.8rem; border:none; background:#3498db; color:#fff; border-radius:4px; cursor:pointer;">
                                View Details
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error fetching adoption requests:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:1.5rem; color: #e74c3c;">Error loading requests. Please try again.</td></tr>';
            }
        }

        // Helper function to get status color
        function getStatusColor(status) {
            switch (status.toLowerCase()) {
                case 'approved':
                    return '#27ae60';
                case 'rejected':
                    return '#e74c3c';
                case 'pending':
                    return '#f39c12';
                case 'unread':
                    return '#3498db';
                default:
                    return '#95a5a6';
            }
        }

        // Update request status
        async function updateRequestStatus(requestId, newStatus) {
            try {
                await db.collection('adoptionRequests').doc(requestId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Refresh the table
                renderAdoptionRequestsTable();
                
                // Show success message
                alert(`Request has been ${newStatus.toLowerCase()}.`);
            } catch (error) {
                console.error('Error updating request status:', error);
                alert('Error updating request status. Please try again.');
            }
        }

        // View request details
        async function viewRequestDetails(requestId) {
            try {
                const requestDoc = await db.collection('adoptionRequests').doc(requestId).get();
                if (!requestDoc.exists) {
                    throw new Error('Request not found');
                }

                const request = requestDoc.data();
                
                // Populate the modal with request details
                document.getElementById('requestDetailType').textContent = request.type === 'visit' ? 'Visit Request' : 'Contact Message';
                document.getElementById('requestDetailDog').textContent = `${request.dogName} (${request.dogBreed})`;
                document.getElementById('requestDetailStatus').textContent = request.status;
                document.getElementById('requestDetailStatus').style.backgroundColor = getStatusColor(request.status);
                document.getElementById('requestDetailDate').textContent = request.createdAt ? new Date(request.createdAt.toDate()).toLocaleString() : 'N/A';

                const specificDetailsDiv = document.getElementById('requestSpecificDetails');
                let specificDetailsHtml = '';

                if (request.type === 'visit') {
                    specificDetailsHtml = `
                        <p><strong>Visitor Name:</strong> ${request.visitorName}</p>
                        <p><strong>Email:</strong> ${request.visitorEmail}</p>
                        <p><strong>Phone:</strong> ${request.visitorPhone}</p>
                        <p><strong>Visit Date:</strong> ${request.visitDate}</p>
                        <p><strong>Time Slot:</strong> ${request.visitTime}</p>
                        <p><strong>Message:</strong> ${request.message || 'No message'}</p>
                    `;
                } else {
                    specificDetailsHtml = `
                        <p><strong>Sender Name:</strong> ${request.senderName}</p>
                        <p><strong>Email:</strong> ${request.senderEmail}</p>
                        <p><strong>Subject:</strong> ${request.subject}</p>
                        <p><strong>Message:</strong> ${request.message}</p>
                    `;
                }
                specificDetailsDiv.innerHTML = specificDetailsHtml;

                // Display the modal
                document.getElementById('requestDetailsModal').style.display = 'block';

            } catch (error) {
                console.error('Error fetching request details:', error);
                alert('Error loading request details. Please try again.');
            }
        }

        // Function to close the request details modal
        function closeRequestDetailsModal() {
            document.getElementById('requestDetailsModal').style.display = 'none';
        }

        // Render table when the section is shown
        document.querySelector('a[data-section="adoption-requests"]').addEventListener('click', renderAdoptionRequestsTable);
        document.querySelector('.portal-action[data-section="adoption-requests"]').addEventListener('click', renderAdoptionRequestsTable);
    </script>
</body>
</html> 